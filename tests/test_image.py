# -*- coding: utf-8 -*-
import math
import iscc
from iscc_samples import images
from iscc.codec import Code
from iscc.schema import Features
from tests.test_readables import image_readables


# TODO add testcase for images with alpha transparency


def test_code_image_plain():
    assert iscc.code_image(
        images()[0], image_preview=False, image_granular=False
    ) == dict(
        code="EEA4GQZQTY6J5DTH",
        width=200,
        height=133,
    )


def test_code_image_granular():
    assert iscc.code_image(images()[0], image_preview=False, image_granular=True) == {
        "code": "EEA4GQZQTY6J5DTH",
        "features": {
            "features": [
                "LX_6ZHK_v84",
                "ab79w3Lb-3Y",
                "FVfv7v_vePo",
                "-f9Oe-nrr98",
                "_dfa63rtqjA",
                "9__fpqXolZQ",
                "Xf6P7q_4-9M",
                "OAiKKhQWY2w",
                "XfnMv-j1oVI",
                "Kr8MIe5yogs",
                "2dwt-uPtyVo",
                "6f2q_m7UrVo",
                "9__u6_7l-2I",
                "o_8nXM1-m8Y",
                "vP_me9xsr28",
                "7fyjYPh9uVM",
                "Y_9goKj8-wM",
                "y-sYG2TW_jM",
                "Jat8cuBzsaA",
                "st4wUarm0rI",
                "mZa337yWn18",
                "97ZlKUM20T4",
                "TJoQQKEE-ws",
                "O3yfqMDwMVc",
            ],
            "kind": "image",
            "positions": [
                (37.5, 45.865),
                (37.2, 46.015),
                (37.44, 46.556),
                (39.0, 45.865),
                (39.0, 46.015),
                (61.0, 40.602),
                (38.88, 47.639),
                (30.0, 72.18),
                (39.0, 47.82),
                (51.0, 69.925),
                (38.88, 46.773),
                (42.48, 50.887),
                (37.152, 46.773),
                (50.0, 38.346),
                (39.0, 48.12),
                (42.6, 50.526),
                (42.336, 51.97),
                (58.32, 42.226),
                (41.472, 55.868),
                (49.8, 37.895),
                (35.4, 45.113),
                (56.88, 51.97),
                (54.95, 48.332),
                (58.061, 48.332),
            ],
            "sizes": [
                15.5,
                18.6,
                22.32,
                15.5,
                18.6,
                15.5,
                22.32,
                15.5,
                18.6,
                15.5,
                26.784,
                22.32,
                26.784,
                15.5,
                15.5,
                18.6,
                26.784,
                22.32,
                26.784,
                18.6,
                18.6,
                22.32,
                32.141,
                32.141,
            ],
            "version": 0,
        },
        "height": 133,
        "width": 200,
    }


def test_code_image_with_meta():
    assert iscc.code_image(
        images()[2], image_preview=False, image_granular=False
    ) == dict(
        code="EEA4GQZQTY6J5DTH",
        title="Concentrated Cat",
        width=200,
        height=133,
    )


def test_code_image_bits32():
    cidi32 = iscc.code_image(
        images()[0], image_bits=32, image_preview=False, image_granular=False
    )
    assert cidi32 == dict(code="EEAMGQZQTY", width=200, height=133)
    c1 = Code(cidi32["code"])
    assert c1.length == 32
    cidi64 = iscc.code_image(
        images()[0], image_bits=32, image_preview=False, image_granular=False
    )
    c2 = Code(cidi64["code"])
    assert c1 ^ c2 == 0


def test_code_image_preview():
    cidi = iscc.code_image(images()[0], image_preview=True, image_granular=False)
    preview = cidi["preview"]
    assert preview.startswith("data:image/webp;base64,UklGRl4DAABXRUJQVlA4IFIDAACQEwCd")
    assert preview.endswith("U0YXrp8k4FtKO0FRbKeE7aFq4V66Ybga9t8TC+QV/hK62WDyAxPciuoAA")


def test_normalize_image_inputs():
    for r in image_readables():
        pix = iscc.normalize_image(r)
        assert pix[0] == [
            25,
            18,
            14,
            15,
            25,
            79,
            92,
            92,
            106,
            68,
            110,
            101,
            99,
            93,
            74,
            69,
            58,
            52,
            52,
            73,
            153,
            159,
            131,
            81,
            95,
            81,
            91,
            78,
            50,
            20,
            24,
            26,
        ]


def test_normalize_image_dimensions():
    pixels = iscc.normalize_image(images()[0])
    assert len(pixels) == 32
    assert len(pixels[0]) == 32


def test_hash_image_reference():
    image_hashes = []
    for img_path in images():
        pixels = iscc.normalize_image(img_path)
        image_hash = iscc.hash_image_pixels(pixels)
        image_hashes.append(image_hash.hex())
    assert image_hashes == [
        "c343309e3c9e8e67",
        "c343309e3c9e8e67",
        "c343309e3c9e8e67",
        "c343309e3c9e8e67",
        "c343309e3c9e8e67",
        "c343309e3c9e8e67",
    ]


def test_extract_image_metadata():
    assert iscc.extract_image_metadata(images()[0].as_posix()) is None
    assert iscc.extract_image_metadata(images()[2].as_posix()) == {
        "title": "Concentrated Cat"
    }


def test_extract_image_metadata_readables():
    for readable in image_readables():
        assert iscc.extract_image_metadata(readable) == {"title": "Concentrated Cat"}


def test_pi():
    """Check assumption that PI has expected value on system"""
    assert math.pi == 3.141592653589793


def test_normalize_image():
    assert iscc.normalize_image("file_image_cat.jpg") == [
        [
            25,
            18,
            14,
            15,
            25,
            79,
            91,
            92,
            106,
            68,
            109,
            101,
            99,
            93,
            74,
            69,
            58,
            52,
            52,
            73,
            153,
            159,
            131,
            81,
            95,
            81,
            91,
            78,
            50,
            20,
            24,
            26,
        ],
        [
            19,
            17,
            10,
            11,
            17,
            69,
            108,
            112,
            73,
            80,
            113,
            98,
            107,
            90,
            73,
            76,
            87,
            67,
            44,
            112,
            175,
            161,
            122,
            76,
            98,
            69,
            57,
            73,
            51,
            18,
            20,
            23,
        ],
        [
            15,
            19,
            11,
            9,
            12,
            65,
            142,
            96,
            71,
            97,
            110,
            129,
            122,
            70,
            67,
            69,
            102,
            130,
            124,
            167,
            182,
            169,
            104,
            48,
            89,
            72,
            44,
            62,
            53,
            18,
            19,
            23,
        ],
        [
            14,
            18,
            11,
            7,
            7,
            112,
            201,
            173,
            102,
            94,
            124,
            129,
            94,
            71,
            76,
            77,
            116,
            134,
            155,
            177,
            206,
            178,
            85,
            34,
            70,
            72,
            46,
            44,
            50,
            19,
            18,
            20,
        ],
        [
            14,
            17,
            12,
            6,
            7,
            108,
            189,
            214,
            185,
            98,
            91,
            101,
            87,
            85,
            80,
            83,
            108,
            122,
            138,
            177,
            213,
            188,
            54,
            32,
            36,
            50,
            49,
            36,
            41,
            20,
            17,
            20,
        ],
        [
            17,
            20,
            12,
            6,
            8,
            89,
            186,
            213,
            207,
            173,
            80,
            83,
            93,
            90,
            73,
            95,
            112,
            96,
            80,
            126,
            182,
            175,
            47,
            28,
            36,
            26,
            37,
            43,
            43,
            22,
            18,
            21,
        ],
        [
            19,
            20,
            14,
            7,
            7,
            70,
            181,
            223,
            209,
            190,
            149,
            116,
            121,
            99,
            72,
            86,
            122,
            99,
            106,
            122,
            118,
            127,
            63,
            22,
            38,
            32,
            29,
            47,
            49,
            24,
            18,
            21,
        ],
        [
            19,
            22,
            17,
            8,
            7,
            63,
            144,
            221,
            224,
            207,
            177,
            130,
            131,
            89,
            98,
            75,
            100,
            123,
            124,
            131,
            129,
            90,
            54,
            18,
            33,
            45,
            33,
            48,
            44,
            24,
            19,
            21,
        ],
        [
            20,
            23,
            18,
            10,
            6,
            53,
            97,
            194,
            221,
            216,
            200,
            154,
            130,
            112,
            100,
            93,
            104,
            144,
            129,
            107,
            106,
            70,
            45,
            22,
            26,
            40,
            34,
            51,
            41,
            23,
            21,
            22,
        ],
        [
            21,
            24,
            19,
            10,
            5,
            44,
            98,
            179,
            215,
            221,
            189,
            152,
            155,
            124,
            116,
            103,
            110,
            147,
            146,
            136,
            106,
            81,
            53,
            23,
            27,
            28,
            36,
            52,
            38,
            23,
            21,
            22,
        ],
        [
            23,
            25,
            21,
            12,
            4,
            28,
            104,
            162,
            197,
            208,
            191,
            180,
            170,
            140,
            134,
            120,
            106,
            139,
            125,
            133,
            115,
            88,
            62,
            23,
            37,
            44,
            39,
            56,
            37,
            25,
            24,
            24,
        ],
        [
            23,
            25,
            21,
            13,
            5,
            16,
            88,
            113,
            158,
            189,
            183,
            169,
            167,
            154,
            129,
            124,
            133,
            127,
            160,
            156,
            120,
            107,
            72,
            28,
            36,
            41,
            48,
            60,
            40,
            29,
            28,
            28,
        ],
        [
            24,
            25,
            20,
            15,
            8,
            6,
            76,
            128,
            161,
            172,
            176,
            153,
            168,
            169,
            134,
            94,
            155,
            126,
            115,
            98,
            103,
            84,
            75,
            32,
            32,
            40,
            50,
            72,
            42,
            31,
            30,
            30,
        ],
        [
            26,
            23,
            19,
            16,
            12,
            3,
            55,
            131,
            164,
            163,
            185,
            191,
            182,
            175,
            168,
            129,
            150,
            132,
            65,
            126,
            134,
            82,
            50,
            35,
            33,
            47,
            56,
            72,
            38,
            30,
            29,
            29,
        ],
        [
            26,
            23,
            20,
            18,
            17,
            10,
            30,
            128,
            167,
            181,
            195,
            176,
            147,
            208,
            182,
            158,
            130,
            108,
            141,
            128,
            157,
            109,
            87,
            34,
            33,
            45,
            57,
            49,
            32,
            29,
            29,
            31,
        ],
        [
            25,
            23,
            20,
            19,
            20,
            20,
            23,
            108,
            175,
            168,
            168,
            203,
            148,
            202,
            223,
            166,
            128,
            75,
            84,
            133,
            145,
            114,
            81,
            34,
            40,
            53,
            44,
            30,
            31,
            33,
            32,
            34,
        ],
        [
            25,
            22,
            20,
            24,
            28,
            26,
            20,
            81,
            146,
            134,
            210,
            162,
            199,
            151,
            225,
            175,
            129,
            91,
            137,
            173,
            103,
            82,
            57,
            39,
            56,
            62,
            33,
            27,
            37,
            40,
            35,
            36,
        ],
        [
            25,
            24,
            26,
            27,
            34,
            39,
            22,
            32,
            142,
            207,
            194,
            185,
            134,
            151,
            216,
            202,
            130,
            69,
            145,
            125,
            104,
            98,
            67,
            57,
            71,
            55,
            38,
            39,
            37,
            37,
            39,
            39,
        ],
        [
            27,
            27,
            28,
            26,
            31,
            41,
            40,
            27,
            94,
            207,
            212,
            162,
            179,
            201,
            159,
            211,
            140,
            49,
            100,
            125,
            116,
            86,
            75,
            69,
            56,
            40,
            41,
            35,
            36,
            40,
            40,
            43,
        ],
        [
            29,
            28,
            31,
            28,
            30,
            37,
            43,
            44,
            65,
            138,
            202,
            194,
            167,
            176,
            136,
            196,
            157,
            59,
            99,
            111,
            113,
            91,
            81,
            54,
            21,
            24,
            34,
            41,
            40,
            44,
            42,
            44,
        ],
        [
            27,
            28,
            37,
            30,
            30,
            35,
            37,
            44,
            39,
            101,
            199,
            223,
            216,
            209,
            183,
            181,
            173,
            87,
            111,
            131,
            125,
            109,
            101,
            49,
            26,
            30,
            35,
            42,
            44,
            47,
            45,
            46,
        ],
        [
            27,
            28,
            36,
            32,
            34,
            36,
            33,
            36,
            39,
            118,
            233,
            232,
            241,
            212,
            227,
            180,
            119,
            150,
            139,
            142,
            146,
            142,
            131,
            60,
            49,
            50,
            44,
            43,
            46,
            48,
            47,
            47,
        ],
        [
            30,
            36,
            34,
            41,
            43,
            45,
            44,
            56,
            61,
            104,
            241,
            250,
            249,
            231,
            239,
            224,
            139,
            197,
            157,
            164,
            171,
            177,
            153,
            48,
            42,
            56,
            60,
            58,
            53,
            46,
            47,
            48,
        ],
        [
            36,
            46,
            34,
            40,
            53,
            58,
            61,
            54,
            63,
            105,
            219,
            254,
            242,
            241,
            240,
            215,
            170,
            178,
            174,
            214,
            208,
            196,
            167,
            68,
            45,
            58,
            52,
            46,
            48,
            45,
            46,
            49,
        ],
        [
            47,
            52,
            39,
            40,
            47,
            54,
            63,
            75,
            99,
            104,
            137,
            209,
            200,
            182,
            220,
            215,
            180,
            109,
            123,
            242,
            236,
            214,
            163,
            60,
            59,
            49,
            62,
            55,
            50,
            44,
            47,
            50,
        ],
        [
            59,
            52,
            42,
            38,
            52,
            63,
            70,
            98,
            95,
            82,
            72,
            110,
            122,
            105,
            121,
            121,
            94,
            50,
            68,
            220,
            249,
            216,
            127,
            67,
            60,
            55,
            42,
            58,
            57,
            41,
            46,
            54,
        ],
        [
            67,
            62,
            54,
            33,
            67,
            87,
            82,
            92,
            79,
            70,
            61,
            102,
            90,
            82,
            73,
            72,
            71,
            57,
            41,
            110,
            187,
            133,
            88,
            81,
            68,
            57,
            48,
            58,
            65,
            46,
            45,
            53,
        ],
        [
            73,
            72,
            52,
            37,
            81,
            87,
            85,
            88,
            64,
            70,
            76,
            87,
            81,
            75,
            75,
            75,
            79,
            68,
            51,
            55,
            69,
            51,
            73,
            79,
            76,
            57,
            62,
            55,
            65,
            55,
            46,
            52,
        ],
        [
            78,
            72,
            41,
            51,
            78,
            74,
            91,
            85,
            54,
            78,
            91,
            72,
            84,
            74,
            76,
            73,
            77,
            75,
            59,
            57,
            66,
            50,
            66,
            75,
            62,
            57,
            69,
            63,
            55,
            61,
            54,
            51,
        ],
        [
            73,
            71,
            56,
            66,
            69,
            77,
            88,
            77,
            57,
            82,
            97,
            68,
            81,
            74,
            72,
            74,
            77,
            66,
            64,
            61,
            65,
            54,
            66,
            69,
            60,
            59,
            61,
            71,
            54,
            64,
            51,
            55,
        ],
        [
            70,
            68,
            64,
            67,
            67,
            71,
            79,
            68,
            66,
            82,
            87,
            69,
            78,
            73,
            73,
            73,
            76,
            66,
            62,
            68,
            66,
            58,
            67,
            62,
            64,
            60,
            62,
            62,
            55,
            64,
            49,
            52,
        ],
        [
            77,
            69,
            64,
            70,
            64,
            68,
            70,
            72,
            73,
            84,
            76,
            72,
            78,
            78,
            75,
            73,
            77,
            67,
            67,
            65,
            71,
            59,
            65,
            66,
            66,
            65,
            61,
            65,
            54,
            62,
            50,
            52,
        ],
    ]


def test_extract_image_features_readables():
    for r in image_readables():
        fo = Features(**iscc.extract_image_features(r))
        assert fo.features[0] == "7XzuZHrfv-w"
        assert fo.sizes[0] == 15.5
        # assert fo.positions[0] == (37.5, 45.865)
        assert fo.features[-1] == "O3yfqMDwMVc"
        assert fo.sizes[-1] == 32.141
        # assert fo.positions[-1] == (58.061, 48.332)
